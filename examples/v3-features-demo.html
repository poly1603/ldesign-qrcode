<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QRCode v3.0 - 新功能演示</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }

    h1 {
      color: #333;
      border-bottom: 3px solid #667eea;
      padding-bottom: 10px;
    }

    .section {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .section h2 {
      color: #667eea;
      margin-top: 0;
    }

    .demo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .demo-item {
      text-align: center;
    }

    .demo-item h3 {
      font-size: 14px;
      color: #666;
      margin: 10px 0 5px 0;
    }

    .qr-container {
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px;
      display: inline-block;
    }

    .stats {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 4px;
      padding: 15px;
      margin-top: 15px;
      font-family: monospace;
      font-size: 12px;
      white-space: pre-wrap;
    }

    .controls {
      margin: 15px 0;
    }

    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
      font-size: 14px;
    }

    button:hover {
      background: #5568d3;
    }

    .badge {
      display: inline-block;
      background: #10b981;
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      margin-left: 8px;
    }
  </style>
</head>

<body>
  <h1>🚀 QRCode v3.0 - 新功能演示</h1>

  <!-- WebGL 渲染 -->
  <div class="section">
    <h2>⚡ WebGL 渲染 <span class="badge">GPU加速</span></h2>
    <p>使用GPU加速渲染复杂效果，性能提升3-5倍</p>
    <div class="demo-grid">
      <div class="demo-item">
        <h3>Canvas 渲染</h3>
        <div id="canvas-demo"></div>
        <div id="canvas-time" class="stats"></div>
      </div>
      <div class="demo-item">
        <h3>WebGL 渲染</h3>
        <div id="webgl-demo"></div>
        <div id="webgl-time" class="stats"></div>
      </div>
    </div>
  </div>

  <!-- 高级滤镜 -->
  <div class="section">
    <h2>🎨 高级滤镜系统</h2>
    <p>15+ 种图像处理滤镜</p>
    <div class="demo-grid">
      <div class="demo-item">
        <h3>复古滤镜</h3>
        <div id="filter-vintage"></div>
      </div>
      <div class="demo-item">
        <h3>素描滤镜</h3>
        <div id="filter-sketch"></div>
      </div>
      <div class="demo-item">
        <h3>像素化</h3>
        <div id="filter-pixelate"></div>
      </div>
      <div class="demo-item">
        <h3>滤镜链</h3>
        <div id="filter-chain"></div>
      </div>
    </div>
  </div>

  <!-- 3D变换 -->
  <div class="section">
    <h2>🌐 3D 变换系统</h2>
    <p>完整的3D透视、旋转和光照支持</p>
    <div class="demo-grid">
      <div class="demo-item">
        <h3>X轴旋转</h3>
        <div id="transform-rotateX"></div>
      </div>
      <div class="demo-item">
        <h3>Y轴旋转</h3>
        <div id="transform-rotateY"></div>
      </div>
      <div class="demo-item">
        <h3>透视投影</h3>
        <div id="transform-perspective"></div>
      </div>
      <div class="demo-item">
        <h3>光照效果</h3>
        <div id="transform-lighting"></div>
      </div>
    </div>
  </div>

  <!-- 内存优化 -->
  <div class="section">
    <h2>💾 内存优化</h2>
    <p>对象池和BitArray大幅减少内存占用</p>
    <div class="controls">
      <button onclick="testObjectPool()">测试对象池</button>
      <button onclick="testBitArray()">测试 BitArray</button>
      <button onclick="testMemoryComparison()">内存对比</button>
    </div>
    <div id="memory-stats" class="stats"></div>
  </div>

  <!-- 缓存系统 -->
  <div class="section">
    <h2>⚡ 分层缓存系统</h2>
    <p>L1内存缓存 + L2持久化缓存</p>
    <div class="controls">
      <button onclick="testCache()">测试缓存性能</button>
      <button onclick="showCacheStats()">查看缓存统计</button>
      <button onclick="clearAllCache()">清除缓存</button>
    </div>
    <div id="cache-stats" class="stats"></div>
  </div>

  <!-- 性能基准 -->
  <div class="section">
    <h2>📊 性能基准测试</h2>
    <div class="controls">
      <button onclick="runBenchmark()">运行完整基准测试</button>
    </div>
    <div id="benchmark-results" class="stats"></div>
  </div>

  <script type="module">
    import {
      createQRCode,
      isWebGLSupported,
      getAllPoolStats,
      cleanupAllPools,
      BitArray,
      BitMatrix,
      calculateMemorySavings,
      getCacheStats,
      clearCache,
      preloadCache,
    } from '../dist/index.esm.js';

    // WebGL vs Canvas 对比
    function renderComparison() {
      const config = {
        content: 'https://example.com',
        style: {
          size: 250,
          gradient: {
            type: 'linear',
            colors: ['#667eea', '#764ba2', '#f093fb'],
            direction: 45,
          },
          dotStyle: 'rounded',
        },
      };

      // Canvas
      const canvasStart = performance.now();
      createQRCode({
        ...config,
        container: document.getElementById('canvas-demo'),
        renderType: 'canvas',
      });
      const canvasTime = performance.now() - canvasStart;
      document.getElementById('canvas-time').textContent =
        `渲染时间: ${canvasTime.toFixed(2)}ms`;

      // WebGL
      if (isWebGLSupported()) {
        const webglStart = performance.now();
        createQRCode({
          ...config,
          container: document.getElementById('webgl-demo'),
          renderType: 'webgl',
        });
        const webglTime = performance.now() - webglStart;
        document.getElementById('webgl-time').textContent =
          `渲染时间: ${webglTime.toFixed(2)}ms\n加速: ${(canvasTime / webglTime).toFixed(2)}x`;
      } else {
        document.getElementById('webgl-demo').innerHTML =
          '<p style="color: #999;">WebGL不支持</p>';
      }
    }

    // 滤镜演示
    function renderFilters() {
      const baseConfig = {
        content: 'https://example.com/filter-demo',
        style: { size: 200 },
      };

      // 复古
      createQRCode({
        ...baseConfig,
        container: document.getElementById('filter-vintage'),
        style: {
          ...baseConfig.style,
          filter: { type: 'vintage', intensity: 0.8 },
        },
      });

      // 素描
      createQRCode({
        ...baseConfig,
        container: document.getElementById('filter-sketch'),
        style: {
          ...baseConfig.style,
          filter: { type: 'sketch', threshold: 120 },
        },
      });

      // 像素化
      createQRCode({
        ...baseConfig,
        container: document.getElementById('filter-pixelate'),
        style: {
          ...baseConfig.style,
          filter: { type: 'pixelate', radius: 8 },
        },
      });

      // 滤镜链
      createQRCode({
        ...baseConfig,
        container: document.getElementById('filter-chain'),
        style: {
          ...baseConfig.style,
          filter: [
            { type: 'sepia', intensity: 0.5 },
            { type: 'contrast', intensity: 0.2 },
            { type: 'blur', radius: 1 },
          ],
        },
      });
    }

    // 3D变换演示
    function render3DTransforms() {
      const baseConfig = {
        content: 'https://example.com/3d',
        style: { size: 200 },
      };

      // X轴旋转
      createQRCode({
        ...baseConfig,
        container: document.getElementById('transform-rotateX'),
        style: {
          ...baseConfig.style,
          transform3D: {
            rotateX: 30,
            perspective: 800,
          },
        },
      });

      // Y轴旋转
      createQRCode({
        ...baseConfig,
        container: document.getElementById('transform-rotateY'),
        style: {
          ...baseConfig.style,
          transform3D: {
            rotateY: 30,
            perspective: 800,
          },
        },
      });

      // 透视
      createQRCode({
        ...baseConfig,
        container: document.getElementById('transform-perspective'),
        style: {
          ...baseConfig.style,
          transform3D: {
            rotateX: 20,
            rotateY: 20,
            rotateZ: 5,
            perspective: 600,
          },
        },
      });

      // 光照
      createQRCode({
        ...baseConfig,
        container: document.getElementById('transform-lighting'),
        style: {
          ...baseConfig.style,
          transform3D: {
            rotateX: 30,
            rotateY: 20,
            perspective: 800,
            lightSource: { x: 1, y: 1, z: 1 },
            ambientLight: 0.4,
            diffuseLight: 0.8,
          },
        },
      });
    }

    // 全局函数供按钮调用
    window.testObjectPool = function () {
      const stats = getAllPoolStats();
      document.getElementById('memory-stats').textContent =
        JSON.stringify(stats, null, 2);
    };

    window.testBitArray = function () {
      const array = new BitArray(1000);
      for (let i = 0; i < 100; i++) {
        array.set(i * 10);
      }

      const matrix = new BitMatrix(21, 21);
      matrix.set(10, 10);

      document.getElementById('memory-stats').textContent =
        `BitArray: ${array.count()} bits 设置\n` +
        `ByteSize: ${array.getByteSize()} bytes\n` +
        `BitMatrix: ${matrix.getByteSize()} bytes`;
    };

    window.testMemoryComparison = function () {
      const savings = calculateMemorySavings(177);
      document.getElementById('memory-stats').textContent =
        `Version 40 QR码 (177x177):\n` +
        `布尔数组: ${savings.booleanArray} bytes\n` +
        `位数组: ${savings.bitArray} bytes\n` +
        `节省: ${savings.savings} bytes (${savings.savingsPercent.toFixed(1)}%)`;
    };

    window.testCache = async function () {
      const iterations = 10;
      const config = {
        content: 'cache-test',
        style: { size: 200 },
      };

      const times = [];
      for (let i = 0; i < iterations; i++) {
        const start = performance.now();
        const div = document.createElement('div');
        createQRCode({ ...config, container: div });
        times.push(performance.now() - start);
      }

      const avgTime = times.reduce((a, b) => a + b, 0) / times.length;
      const stats = getCacheStats();

      document.getElementById('cache-stats').textContent =
        `平均渲染时间: ${avgTime.toFixed(2)}ms\n` +
        `缓存统计:\n${JSON.stringify(stats, null, 2)}`;
    };

    window.showCacheStats = function () {
      const stats = getCacheStats();
      document.getElementById('cache-stats').textContent =
        JSON.stringify(stats, null, 2);
    };

    window.clearAllCache = async function () {
      await clearCache();
      document.getElementById('cache-stats').textContent = '缓存已清除';
    };

    window.runBenchmark = function () {
      const results = [];

      // 简单QR码
      const simple = [];
      for (let i = 0; i < 50; i++) {
        const start = performance.now();
        const div = document.createElement('div');
        createQRCode({
          content: `test-${i}`,
          container: div,
          style: { size: 200 },
        });
        simple.push(performance.now() - start);
      }

      results.push(`简单QR码 (50次):`);
      results.push(`  平均: ${(simple.reduce((a, b) => a + b) / simple.length).toFixed(2)}ms`);
      results.push(`  最小: ${Math.min(...simple).toFixed(2)}ms`);
      results.push(`  最大: ${Math.max(...simple).toFixed(2)}ms`);
      results.push('');

      // 复杂渐变
      const complex = [];
      for (let i = 0; i < 20; i++) {
        const start = performance.now();
        const div = document.createElement('div');
        createQRCode({
          content: `complex-${i}`,
          container: div,
          style: {
            size: 300,
            gradient: {
              type: 'radial',
              colors: ['#667eea', '#764ba2', '#f093fb'],
            },
            dotStyle: 'dots',
          },
        });
        complex.push(performance.now() - start);
      }

      results.push(`复杂渐变 (20次):`);
      results.push(`  平均: ${(complex.reduce((a, b) => a + b) / complex.length).toFixed(2)}ms`);
      results.push(`  最小: ${Math.min(...complex).toFixed(2)}ms`);
      results.push(`  最大: ${Math.max(...complex).toFixed(2)}ms`);

      document.getElementById('benchmark-results').textContent = results.join('\n');
    };

    // 初始化渲染
    renderComparison();
    renderFilters();
    render3DTransforms();
  </script>
</body>

</html>
